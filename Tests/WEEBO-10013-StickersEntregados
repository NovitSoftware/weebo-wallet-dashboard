DECLARE @FechaInicio DATE = '2019-04-09'; -- Cambiar según el periodo deseado
DECLARE @FechaFin DATE = '2023-11-30';

-- Total de stickers entregados en el periodo actual
WITH TotalStickersActual AS (
    SELECT 
        SUM(stickers) AS TotalActual
    FROM Apployalty.dbo.tracking_stickers
    WHERE fecha BETWEEN @FechaInicio AND @FechaFin
),
-- Total de stickers entregados en el mismo periodo del año anterior
TotalStickersAnterior AS (
    SELECT 
        SUM(stickers) AS TotalAnterior
    FROM Apployalty.dbo.tracking_stickers
    WHERE fecha BETWEEN DATEADD(YEAR, -1, @FechaInicio) AND DATEADD(YEAR, -1, @FechaFin)
),
-- Promedio de stickers entregados por día en el periodo actual
PromedioStickers AS (
    SELECT 
        AVG(TotalDiario) AS PromedioActual
    FROM (
        SELECT 
            fecha, 
            SUM(stickers) AS TotalDiario
        FROM Apployalty.dbo.tracking_stickers
        WHERE fecha BETWEEN @FechaInicio AND @FechaFin
        GROUP BY fecha
    ) Diario
)
-- Cálculo final: Total, Promedio y Variación
SELECT 
    (SELECT TotalActual FROM TotalStickersActual) AS TotalStickersEntregados,
    (SELECT PromedioActual FROM PromedioStickers) AS PromedioStickersEntregados,
    CASE 
        WHEN (SELECT TotalAnterior FROM TotalStickersAnterior) = 0 THEN 0
        ELSE 
            (SELECT TotalActual FROM TotalStickersActual) - (SELECT TotalAnterior FROM TotalStickersAnterior)
    END AS VariacionStickersAbsoluta,
    CASE 
        WHEN (SELECT TotalAnterior FROM TotalStickersAnterior) = 0 THEN 0
        ELSE 
            CAST(
                ((SELECT TotalActual FROM TotalStickersActual) - (SELECT TotalAnterior FROM TotalStickersAnterior)) * 100.0 /
                (SELECT TotalAnterior FROM TotalStickersAnterior) 
                AS DECIMAL(10, 2)
            )
    END AS VariacionStickersPorcentual
